<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Hoho3D – Búsqueda por color + Ideas + Visor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Búsqueda por color</h1>
  </header>

  <main class="app">
    <!-- IZQUIERDA (rueda + barra FINITA) -->
    <section class="left">
      <div class="pickers">
        <div class="vbar-wrap">
          <canvas id="vbar" width="28" height="300" aria-label="Luminosidad"></canvas>
        </div>
        <canvas id="wheel" width="320" height="320" aria-label="Rueda de color HSV"></canvas>
      </div>

      <div class="readout">
        <span class="dot" id="dot"></span>
        <span class="tag">RGB: <span id="sel-rgb" class="chip">—</span></span>
        <span class="tag">HEX: <input id="sel-hex" class="chip" style="border:1px solid #2b3a55; outline:none; width:160px" value="" /></span>
      </div>

      <img id="preview-img" class="img-preview" alt="Vista previa del filamento" />
    </section>

    <!-- DERECHA -->
    <section class="card" id="main-card" aria-live="polite">
      <!-- FILTROS JUSTO ARRIBA DEL RECTÁNGULO -->
      <div class="filters">
        <select id="typeFilter" class="select" title="Filtrar por tipo">
          <option value="*">Tipos de filamento ▾</option>
          <option>PLA</option>
          <option>PLA+</option>
          <option>ABS</option>
          <option>PETG</option>
          <option>FLEX</option>
          <option>PLAFLEX</option>
        </select>
        <input id="q" class="input" type="search" placeholder="Buscar por color, marca o #hex" autocomplete="off" />
        <div id="sugs" class="suggestions" role="listbox" aria-label="Resultados"></div>
      </div>

      <div class="main-swatch" id="main-sw"></div>
      <h2 id="main-name" style="margin:0 0 6px 0; font-size:20px">—</h2>

      <div class="meta">
        <div><strong>Marca:</strong> <span id="main-brand">—</span></div>
        <div><strong>Tipo:</strong> <span id="main-type">—</span></div>
        <div><strong>Estilo:</strong> <span id="main-style">—</span></div>
        <div><strong>Temp.:</strong> <span id="main-temp">—</span></div>
        <div><strong>Resist.:</strong> <span id="main-strength">—</span></div>
        <div><strong>HEX:</strong> <span id="main-hex">—</span></div>
      </div>

      <!-- Acciones: CTA + Ideas + Imagen de referencia (al lado) -->
      <div class="actions">
        <a id="main-link" class="btn btn-cta" href="#" target="_blank" rel="noopener">¡Comprar ahora!</a>
        <button id="ideas-btn" class="btn" type="button">Creador de Ideas</button>
        <label class="btn" for="refImage">Usa una imagen de referencia</label>
        <input id="refImage" type="file" accept="image/*" />
      </div>

      <div id="ideas-box" class="card" style="margin-top:12px; display:none">
        <h3 style="margin:0 0 8px 0; font-size:16px">Ideas</h3>
        <ul id="ideas-list" style="margin:0; padding-left:18px"></ul>
      </div>

      <article class="card" style="margin-top:14px">
        <h2 style="margin:0 0 8px 0; font-size:18px">Otras sugerencias</h2>
        <div class="subs">
          <div class="sub" id="sub-1">
            <div class="sw" id="sub1-sw"></div>
            <div>
              <h3 id="sub1-name">—</h3>
              <small id="sub1-desc">—</small>
            </div>
            <button class="btn btn-mini" id="sub1-btn">Ver</button>
          </div>
          <div class="sub" id="sub-2">
            <div class="sw" id="sub2-sw"></div>
            <div>
              <h3 id="sub2-name">—</h3>
              <small id="sub2-desc">—</small>
            </div>
            <button class="btn btn-mini" id="sub2-btn">Ver</button>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Lightbox producto -->
  <div class="lightbox" id="lightbox">
    <button class="close" id="lb-close">Cerrar</button>
    <img id="lb-img" alt="Imagen del filamento" />
  </div>

  <!-- Modal eyedropper -->
  <div class="modal" id="eyeModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Selecciona un color desde tu imagen</h3>
        <div class="pill">Haz clic en la imagen para tomar el color exacto</div>
      </div>
      <canvas id="eyeCanvas" width="960" height="520"></canvas>
      <div class="actions" style="margin-top:10px; justify-content:flex-end">
        <button class="btn" id="eye-close">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?output=tsv";

    /* ====== HELPERS ====== */
    const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
    const norm = s => (s==null? '' : String(s).trim());
    function normalizeHex(h){
      if (typeof h !== 'string') return null;
      const s = h.trim();
      const r3=/^#?[0-9a-fA-F]{3}$/; const r6=/^#?[0-9a-fA-F]{6}$/;
      if (r3.test(s)){ const p=s.replace('#',''); return '#'+p.split('').map(c=>c+c).join('').toLowerCase(); }
      if (r6.test(s)){ return '#'+s.replace('#','').toLowerCase(); }
      return null;
    }
    function hexToRgb(hex){ const h=hex.replace('#',''); return {r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16)} }
    function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>clamp(Math.round(v),0,255).toString(16).padStart(2,'0')).join('') }
    function rgbFromHsv(h, s, v){
      h = Number(h); s = Number(s); v = Number(v);
      if (s === 0) { const vv=Math.round(v*255); return {r:vv, g:vv, b:vv}; }
      let i=Math.floor(h*6); const f=h*6 - i; const p=v*(1-s); const q=v*(1-s*f); const t=v*(1-s*(1-f)); i%=6;
      let r,g,b;
      if (i===0){ r=v; g=t; b=p; }
      else if(i===1){ r=q; g=v; b=p; }
      else if(i===2){ r=p; g=v; b=t; }
      else if(i===3){ r=p; g=q; b=v; }
      else if(i===4){ r=t; g=p; b=v; }
      else { r=v; g=p; b=q; }
      return { r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255) };
    }
    function colorDistance(a,b){ const dr=a.r-b.r, dg=a.g-b.g, db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db); }

    /* ====== STATE ====== */
    const wheel = document.getElementById('wheel');
    const wctx  = wheel.getContext('2d', { willReadFrequently:true });
    const vbar  = document.getElementById('vbar');
    const vctx  = vbar.getContext('2d');

    const CX = wheel.width/2, CY=wheel.height/2, R=150;
    let H = 0.0, S = 1.0, V = 1.0;
    let draggingWheel = false;
    let draggingV = false;

    let items = [];
    let pool  = [];
    let lastRGB = null;

    /* ====== DRAWERS ====== */
    function drawWheel(){
      const img = wctx.createImageData(wheel.width, wheel.height);
      for(let y=0; y<wheel.height; y++){
        for(let x=0; x<wheel.width; x++){
          const dx=x-CX, dy=y-CY; const dist=Math.sqrt(dx*dx+dy*dy);
          if (dist<=R){
            let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
            const hue=ang/(Math.PI*2), sat=dist/R;
            const {r,g,b} = rgbFromHsv(hue, sat, V);
            const i=(y*wheel.width + x)*4; img.data[i]=r; img.data[i+1]=g; img.data[i+2]=b; img.data[i+3]=255;
          }
        }
      }
      wctx.putImageData(img,0,0);
    }
    function drawVBar(){
      const cTop = rgbFromHsv(H,S,1);
      const grd = vctx.createLinearGradient(0,0,0,vbar.height);
      grd.addColorStop(0, `rgb(${cTop.r},${cTop.g},${cTop.b})`);
      grd.addColorStop(1, `rgb(0,0,0)`);
      vctx.fillStyle=grd;
      vctx.fillRect(0,0,vbar.width,vbar.height);
      const y=(1-V)*vbar.height;
      vctx.fillStyle="#ffffff";
      vctx.fillRect(0, y-1, vbar.width, 2);
    }

    /* ====== IO ====== */
    function updateFromWheel(clientX, clientY){
      const r = wheel.getBoundingClientRect();
      const sx = wheel.width / r.width, sy = wheel.height / r.height;
      const x = (clientX - r.left)*sx, y=(clientY - r.top)*sy;
      const dx=x-CX, dy=y-CY; const dist=Math.sqrt(dx*dx + dy*dy);
      if (dist>R) return;
      let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
      H = ang/(Math.PI*2); S = dist/R;
      const rgb = rgbFromHsv(H,S,V);
      lastRGB = rgb;
      reflectSelection(rgb);
      drawWheel(); drawVBar();
      rankAndRenderBy(rgb);
    }
    function updateFromVBar(clientY){
      const r = vbar.getBoundingClientRect();
      const sy = vbar.height / r.height;
      const y  = (clientY - r.top)*sy;
      V = clamp(1 - (y/vbar.height), 0, 1);
      const rgb = rgbFromHsv(H,S,V);
      lastRGB = rgb;
      reflectSelection(rgb);
      drawWheel(); drawVBar();
      rankAndRenderBy(rgb);
    }

    wheel.addEventListener('mousedown', e=>{ draggingWheel=true; updateFromWheel(e.clientX,e.clientY); });
    window.addEventListener('mousemove', e=>{ if(draggingWheel) updateFromWheel(e.clientX,e.clientY); });
    window.addEventListener('mouseup', ()=> draggingWheel=false);

    vbar.addEventListener('mousedown', e=>{ draggingV=true; updateFromVBar(e.clientY); });
    window.addEventListener('mousemove', e=>{ if(draggingV) updateFromVBar(e.clientY); });
    window.addEventListener('mouseup', ()=> draggingV=false);

    /* ====== CARGA CATÁLOGO ====== */
    async function cargar(){
      const imgPrev = document.getElementById('preview-img');
      try{
        const res = await fetch(sheetUrl, {cache:'no-store', mode:'cors'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        let text = await res.text();
        if(/<\s*html/i.test(text)) throw new Error('La URL devolvió HTML. Publica como TSV/CSV');
        text = text.replace(/^\uFEFF/, '').replace(/\r\n/g,'\n');
        const head = text.split('\n')[0]; const delim = head.includes('\t')? '\t' : ',';
        const rows = text.trim().split('\n').map(l=>l.split(delim));
        const headers = rows.shift().map(h=>h.replace(/^"(.*)"$/,'$1').toLowerCase().trim());
        const ix = k => headers.indexOf(k);
        const idx={
          id: ix('id'),
          name: headers.includes('name')? ix('name') : ix('nombre'),
          hex: ix('hex'),
          brand: headers.includes('brand')? ix('brand') : ix('marca'),
          type: headers.includes('type')? ix('type') : ix('tipo'),
          style: headers.includes('style')? ix('style') : ix('estilo'),
          temp: headers.includes('temp')? ix('temp') : ix('temperatura'),
          strength: headers.includes('strength')? ix('strength') : ix('resistencia'),
          link: headers.includes('link')? ix('link') : ix('url'),
          img: headers.includes('img')? ix('img') : (headers.includes('image')? ix('image'): -1),
          ideas: headers.includes('ideas')? ix('ideas'): -1
        };
        if (idx.hex === -1) throw new Error('Falta columna HEX');
        rows.forEach(r=>{
          const hex = normalizeHex(r[idx.hex]||''); if(!hex) return;
          const it = {
            id: idx.id!==-1? norm(r[idx.id]) : '',
            name: idx.name!==-1? norm(r[idx.name]) : '',
            hex, rgb:hexToRgb(hex),
            brand: idx.brand!==-1? norm(r[idx.brand]) : '',
            type: idx.type!==-1? norm(r[idx.type]) : '',
            style: idx.style!==-1? norm(r[idx.style]) : '',
            temp: idx.temp!==-1? norm(r[idx.temp]) : '',
            strength: idx.strength!==-1? norm(r[idx.strength]) : '',
            link: idx.link!==-1? norm(r[idx.link]) : '#',
            img: idx.img!==-1? norm(r[idx.img]) : '',
            ideas: idx.ideas!==-1? norm(r[idx.ideas]) : ''
          };
          items.push(it);
        });
        pool = items.slice();

        if (items[0]?.img){ imgPrev.src = items[0].img; imgPrev.alt = `Vista previa ${items[0].name}`; }
      }catch(e){ console.error(e); }
    }

    /* ====== RENDERS ====== */
    function reflectSelection(rgb){
      const hex = rgbToHex(rgb.r,rgb.g,rgb.b);
      document.getElementById('dot').style.background = hex;
      document.getElementById('sel-rgb').textContent = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
      document.getElementById('sel-hex').value = hex;
    }
    function renderMainCard(a){
      if(!a) return;
      document.getElementById('main-sw').style.background = a.hex;
      document.getElementById('main-name').textContent   = a.name || 'Sin nombre';
      document.getElementById('main-brand').textContent  = a.brand || '-';
      document.getElementById('main-type').textContent   = a.type || '-';
      document.getElementById('main-style').textContent  = a.style || '-';
      document.getElementById('main-temp').textContent   = a.temp || '-';
      document.getElementById('main-strength').textContent = a.strength || '-';
      document.getElementById('main-hex').textContent    = a.hex;
      document.getElementById('main-link').href          = a.link || '#';

      const prev = document.getElementById('preview-img');
      if (a.img){
        prev.src = a.img; prev.alt=`Vista previa ${a.name}`;
        prev.onerror = ()=>{ prev.removeAttribute('src'); };
        prev.onclick = ()=> openLightbox(a.img);
      } else { prev.removeAttribute('src'); prev.onclick=null; }

      // Ideas toggle
      const ideasBtn = document.getElementById('ideas-btn');
      const ideasBox = document.getElementById('ideas-box');
      const ul = document.getElementById('ideas-list');
      ideasBox.style.display='none'; ul.innerHTML='';
      ideasBtn.onclick = ()=>{
        ul.innerHTML='';
        const ideas = (a.ideas||'').split(';').map(s=>s.trim()).filter(Boolean);
        if (!ideas.length){ ul.innerHTML='<li style="color:var(--muted)">Sin ideas cargadas</li>'; }
        else ideas.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
        ideasBox.style.display='block';
      };
    }
    function renderSide(top){
      const [a,b,c] = top;
      if(!a) return;
      renderMainCard(a);
      const setSub = (prefix, it) => {
        const sw = document.getElementById(prefix+'-sw');
        const nm = document.getElementById(prefix+'-name');
        const ds = document.getElementById(prefix+'-desc');
        const btn= document.getElementById(prefix+'-btn');
        if (!it){ sw.style.background='transparent'; nm.textContent='—'; ds.textContent='—'; btn.onclick=null; return; }
        sw.style.background = it.hex;
        nm.textContent = it.name || 'Sin nombre';
        ds.textContent = `${it.brand||'-'} · ${it.type||'-'} · ${it.style||'-'}`;
        btn.onclick = ()=> { renderMainCard(it); if (it.img) openLightbox(it.img); };
      };
      setSub('sub1', b); setSub('sub2', c);
    }
    function rankAndRenderBy(rgb){
      if (!pool.length) return;
      const ranked = pool.map(it=>({it, d: colorDistance(rgb, it.rgb)})).sort((a,b)=>a.d-b.d).slice(0,3).map(x=>x.it);
      renderSide(ranked);
    }

    /* ====== BUSCADOR + TIPO (dentro de la tarjeta) ====== */
    const inputQ = document.getElementById('q');
    const typeFilter = document.getElementById('typeFilter');
    const sugsBox = document.getElementById('sugs');

    function currentType(){
      const v = (typeFilter.value||'*').trim().toUpperCase();
      return v==='TIPOS DE FILAMENTO ▾' ? '*' : v;
    }
    function filterPoolByType(){
      const t = currentType();
      pool = (t==='*') ? items.slice() : items.filter(it => (it.type||'').toUpperCase()===t);
    }
    function applySearchAndSuggest(q){
      filterPoolByType();
      q = (q||'').trim().toLowerCase();
      let list = pool;
      if (q){
        if (q.startsWith('#')){
          const hx = normalizeHex(q) || '';
          list = pool.filter(it => it.hex.startsWith(hx));
        } else {
          list = pool.filter(it =>
            (it.name||'').toLowerCase().includes(q) ||
            (it.brand||'').toLowerCase().includes(q)
          );
        }
      }
      renderSugs(list);
      if (lastRGB) rankAndRenderBy(lastRGB);
    }
    function showSugs(){ sugsBox.style.display='block'; }
    function hideSugs(){ sugsBox.style.display='none'; sugsBox.innerHTML=''; }
    function renderSugs(list){
      sugsBox.innerHTML='';
      const LIM=100;
      const out=list.slice(0,LIM);
      if (!out.length){
        const empty=document.createElement('div'); empty.className='sug-empty'; empty.textContent='Sin existencias';
        sugsBox.appendChild(empty); showSugs(); return;
      }
      out.forEach(it=>{
        const div=document.createElement('div'); div.className='sug-item';
        const dot=document.createElement('span'); dot.className='sug-dot'; dot.style.background=it.hex;
        const text=document.createElement('div'); text.innerHTML=`<strong>${it.name||'(Sin nombre)'}</strong><div class="sug-meta">${it.brand||'-'} · ${it.hex}</div>`;
        const go=document.createElement('div'); go.textContent='ver'; go.style.fontSize='12px'; go.style.color='var(--accent)';
        div.appendChild(dot); div.appendChild(text); div.appendChild(go);
        div.onclick=()=>{ hideSugs(); inputQ.value = it.name || it.hex; lastRGB = it.rgb;
          document.getElementById('sel-rgb').textContent = `${it.rgb.r}, ${it.rgb.g}, ${it.rgb.b}`;
          document.getElementById('sel-hex').value = it.hex;
          rankAndRenderBy(it.rgb);
        };
        sugsBox.appendChild(div);
      });
      showSugs();
    }
    inputQ.addEventListener('input', e=> applySearchAndSuggest(e.target.value));
    inputQ.addEventListener('focus', ()=>{ if(inputQ.value) applySearchAndSuggest(inputQ.value); });
    document.addEventListener('click', e=>{ if(!sugsBox.contains(e.target) && e.target!==inputQ) hideSugs(); });
    typeFilter.addEventListener('change', ()=> applySearchAndSuggest(inputQ.value));

    /* ====== LIGHTBOX ====== */
    const lb = document.getElementById('lightbox');
    function openLightbox(src){ const img=document.getElementById('lb-img'); img.src=src; lb.classList.add('show'); }
    function closeLightbox(){ lb.classList.remove('show'); const img=document.getElementById('lb-img'); img.removeAttribute('src'); }
    document.getElementById('lb-close').addEventListener('click', closeLightbox);
    lb.addEventListener('click', e=>{ if(e.target.id==='lightbox') closeLightbox(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeLightbox(); closeEye(); } });

    /* ====== HEX EDITABLE ====== */
    document.getElementById('sel-hex').addEventListener('change', e=>{
      const hx = normalizeHex(e.target.value);
      if (!hx) return;
      const rgb = hexToRgb(hx);
      lastRGB = rgb; reflectSelection(rgb); rankAndRenderBy(rgb);
    });

    /* ====== EYEDROPPER EN MODAL ====== */
    const eyeModal = document.getElementById('eyeModal');
    const eyeCanvas= document.getElementById('eyeCanvas');
    const ectx = eyeCanvas.getContext('2d', { willReadFrequently:true });
    function openEye(img){
      ectx.clearRect(0,0,eyeCanvas.width,eyeCanvas.height);
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const cw = eyeCanvas.width, ch=eyeCanvas.height;
      const s = Math.min(cw/iw, ch/ih);
      const w = Math.round(iw*s), h=Math.round(ih*s);
      const x = Math.round((cw - w)/2), y=Math.round((ch - h)/2);
      ectx.drawImage(img, 0,0,iw,ih, x,y,w,h);
      eyeModal.classList.add('show');
    }
    function closeEye(){ eyeModal.classList.remove('show'); }
    eyeCanvas.addEventListener('click', e=>{
      const r = eyeCanvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - r.left) * (eyeCanvas.width / r.width));
      const y = Math.floor((e.clientY - r.top)  * (eyeCanvas.height/ r.height));
      const px = ectx.getImageData(x,y,1,1).data;
      const rgb = { r:px[0], g:px[1], b:px[2] };
      lastRGB = rgb; reflectSelection(rgb); rankAndRenderBy(rgb); closeEye();
    });
    document.getElementById('eye-close').addEventListener('click', closeEye);
    document.getElementById('refImage').addEventListener('change', e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const img = new Image();
      img.onload = ()=> openEye(img);
      img.src = URL.createObjectURL(f);
      e.target.value = '';
    });

    /* ====== INIT ====== */
    function startDefault(){
      H=0; S=1; V=1; drawWheel(); drawVBar();
      const rgb = rgbFromHsv(H,S,V); lastRGB=rgb; reflectSelection(rgb);
    }
    startDefault();
    window.addEventListener('DOMContentLoaded', async ()=>{
      await cargar();
      rankAndRenderBy(lastRGB || rgbFromHsv(H,S,V));
    });
  </script>
</body>
</html>
